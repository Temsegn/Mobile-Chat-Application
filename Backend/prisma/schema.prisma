generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = "postgresql://neondb_owner:npg_0Oc1APfjlSIU@ep-spring-moon-ahzf4izk-pooler.c-3.us-east-1.aws.neon.tech/chat?sslmode=require&channel_binding=require"
}

model User {
  id        Int       @id @default(autoincrement())
  username  String    @unique
  email     String    @unique
  password  String
  avatar    String?
  isOnline  Boolean   @default(false)
  lastSeen  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  conversationsAsParticipantOne Conversation[] @relation("participantOne")
  conversationsAsParticipantTwo Conversation[] @relation("participantTwo")
  messagesSent Message[] @relation("sentMessages")
  groupMemberships GroupMember[]
  messageReactions MessageReaction[]
  readReceipts ReadReceipt[]
  mentions MessageMention[]

  // Contacts
  contacts       Contact[] @relation("userContacts")
  contactsOf     Contact[] @relation("contactOf")
}

model Conversation {
  id             Int       @id @default(autoincrement())
  type           String    @default("private") // "private" or "group"
  participantOne Int?
  participantTwo Int?
  name           String?   // For group chats
  avatar         String?   // For group chats
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  participantOneUser User? @relation("participantOne", fields: [participantOne], references: [id])
  participantTwoUser User? @relation("participantTwo", fields: [participantTwo], references: [id])
  messages          Message[]
  groupMembers      GroupMember[]
}

model GroupMember {
  id             Int    @id @default(autoincrement())
  conversationId Int
  userId         Int
  role           String @default("member") // "admin" or "member"
  muted          Boolean @default(false)
  joinedAt       DateTime @default(now())

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
}

model Message {
  id             Int       @id @default(autoincrement())
  conversationId Int
  senderId       Int
  content        String
  type           String    @default("text") // "text", "image", "video", "audio", "file"
  mediaUrl       String?
  fileName       String?
  fileSize       Int?
  isEdited       Boolean   @default(false)
  isDeleted      Boolean   @default(false)
  deletedForEveryone Boolean @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("sentMessages", fields: [senderId], references: [id])
  reactions    MessageReaction[]
  readReceipts ReadReceipt[]
  mentions     MessageMention[]

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

model MessageReaction {
  id        Int      @id @default(autoincrement())
  messageId Int
  userId    Int
  emoji     String   // e.g., "üëç", "‚ù§Ô∏è", "üòÇ"
  createdAt DateTime @default(now())

  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
}

model MessageMention {
  id        Int      @id @default(autoincrement())
  messageId Int
  userId    Int
  createdAt DateTime @default(now())

  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
}

model ReadReceipt {
  id        Int      @id @default(autoincrement())
  messageId Int
  userId    Int
  readAt    DateTime @default(now())

  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
}

model Contact {
  id        Int      @id @default(autoincrement())
  userId    Int
  contactId Int

  // Relations
  user    User @relation("userContacts", fields: [userId], references: [id])
  contact User @relation("contactOf", fields: [contactId], references: [id])

  @@unique([userId, contactId])
}
